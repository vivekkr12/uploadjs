"use strict";function Uploader(e){this.filesToBeUploaded=[],this.fileTable=document.getElementById(e.fileTableId),this.addBtn=document.getElementById(e.addBtnId),this.removeBtn=document.getElementById(e.removeBtnId),this.uploadBtn=document.getElementById(e.uploadBtnId),this.removeAllBtn=document.getElementById(e.removeAllBtnId),this.serverUrl=e.serverUrl,this.wrapperForm=document.getElementById(e.wrapperFormId),this.setProgress=e.setProgress,this.getProgress=e.getProgress,this.getFileDetails=e.getFileDetails;var t=this,r=e.preAdd,i=e.postAdd,n=e.onDuplicateAdd,a=e.isValidFile,o=e.onCheckFail,s=e.preRemove,l=e.postRemove,d=e.preUpload,f=e.addPayload,p=e.postUpload,v=e.onSuccess,u=e.onError,c=e.preAddBtnAction,h=e.postAddBtnAction,m=e.preRemoveBtnAction,B=e.postRemoveBtnAction,g=e.preRemoveAllBtnAction,y=e.postRemoveAllBtnAction,A=e.preUploadBtnAction,E=e.postUploadBtnAction;this.chunkSize="undefined"!=typeof e.chunkSize?e.chunkSize:this.DEFAULT_CHUNK_SIZE;var T=function(e){c&&c();var s,l;for(l=0;l<e.length;l+=1){if(s=e[l],a){var d=a(s);if(d===!1){o&&o(s);continue}}t.filesToBeUploaded.contains(s)?n?n(s):alert("This file already exists"):(r&&r(s),t.addFile(s),i&&i(s))}t.resetAddBtn(),h&&h()};this.addBtn.addEventListener("change",function(e){var r=t.addBtn.files;T(r)}),this.fileTable.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}),this.fileTable.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files;T(t)}),this.removeBtn.addEventListener("click",function(){m&&m();var r,i,n,e=document.getElementsByClassName("fileRowCheckBox");for(r=e.length-1;r>=0;r-=1)if(i=e[r],i.checked===!0){var a=i.parentElement.parentElement,o=a.rowIndex;n=t.filesToBeUploaded[o-1],s&&s(n),t.remove(o),l&&l(n)}B&&B()}),this.removeAllBtn.addEventListener("click",function(){g&&g();var e;for(e=t.filesToBeUploaded.length;e>0;e-=1)t.remove(e);y&&y()}),this.uploadBtn.addEventListener("click",function(){A&&A();var r,e=document.getElementsByClassName("fileRowCheckBox");if(1===e.length)r=t.filesToBeUploaded[0];else{var i,n;for(i=e.length-1;i>=0;i-=1)if(n=e[i],n.checked===!0){r=t.filesToBeUploaded[i];break}}if(r){d&&d(r);var a;f&&(a=f(r)),t.uploadFile(r,v,u,a),p&&p(r)}E&&E()})}File&&(File.prototype.equals=function(e){return this.name===e.name&&this.size===e.size&&this.type===e.type&&this.lastModified===e.lastModified}),Array.prototype.contains=function(e){if(this.indexOf(e)>-1)return!0;var t,r;for(r=0;r<this.length;r+=1)if(t=this[r],e.equals&&"function"==typeof e.equals){if(t.equals(e))return!0}else if(t===e)return!0;return!1},Array.prototype.removeByElement=function(e){var t=this.indexOf(e);t>-1&&this.splice(t,1)},Array.prototype.removeByIndex=function(e){this.splice(e,1)},Uploader.prototype={constructor:Uploader,DEFAULT_CHUNK_SIZE:1048576,isSupported:function(){return File&&FileList&&FileReader&&Blob&&XMLHttpRequest},resetAddBtn:function(){this.wrapperForm.reset()},addFile:function(e){var t=this.getFileDetails(e),o=(e.name,e.type,e.size,e.lastModified,this.fileTable.insertRow());o.className="fileTableRow",o.insertCell().innerHTML="<input type='checkbox' class='fileRowCheckBox'>";var s;for(s in t)t.hasOwnProperty(s)&&(o.insertCell().innerHTML=t[s]);this.filesToBeUploaded.push(e)},remove:function(e){this.fileTable.deleteRow(e),this.filesToBeUploaded.removeByIndex(e-1)},uploadFile:function(e,t,r,i){var v,n=this,a=new XMLHttpRequest,o=0,s=this.chunkSize,l=o+s,d=e.size,f=e.size%s===0?parseInt(e.size/s,10):parseInt(e.size/s,10)+1,p=function(){a.open("POST",n.serverUrl,!0);var t=new FormData;if(t.append("name",e.name),t.append("blob",e.slice(o,l)),t.append("totalChunks",f),o=l,l=o+s,d-=s,0>=d){t.append("eof",!0);var r;for(r in i)i.hasOwnProperty(r)&&t.append(r,i[r])}else t.append("eof",!1);a.send(t)},u=100/f,c=0;a.upload.onprogress=function(e){n.setProgress&&e.lengthComputable&&(v=c+e.loaded/e.total*u,n.setProgress(v))},a.upload.onloadend=function(e){c=n.getProgress()},a.onreadystatechange=function(i){var n=i.target;n.readyState===XMLHttpRequest.DONE&&200===n.status?d>0?p(n):t(e,n.response):n.readyState===XMLHttpRequest.DONE&&200!==n.status&&r(e,n.response,n.statusText)},p(a)}};