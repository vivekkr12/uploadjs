/*The MIT License (MIT) Copyright (c) 2016 Vivek Kumar https://github.com/vivekkr12/uploadjs/blob/master/LICENSE.md */
"use strict";function Uploader(e){if(this.filesToBeUploaded=[],this.fileTable=document.getElementById(e.fileTableId),this.dropZone=document.getElementById(e.dropZoneId),this.addBtn=document.getElementById(e.addBtnId),this.removeBtn=document.getElementById(e.removeBtnId),this.uploadBtn=document.getElementById(e.uploadBtnId),this.removeAllBtn=document.getElementById(e.removeAllBtnId),this.serverUrl=e.serverUrl,this.wrapperForm=document.getElementById(e.wrapperFormId),this.setProgress=e.setProgress,this.getProgress=e.getProgress,this.getFileDetails=e.getFileDetails,this.selectedRowColor="undefined"==typeof e.selectedRowColor?"#dffff1":e.selectedRowColor,this.removeAfterUploadSuccess="undefined"==typeof e.removeAfterUploadSuccess?!1:e.removeAfterUploadSuccess,this.removeAfterUploadFail="undefined"==typeof e.removeAfterUploadFail?!1:e.removeAfterUploadFail,this.customDisplay="undefined"==typeof e.customDisplay?!1:e.customDisplay,this.customDisplay){if("undefined"==typeof e.displayAddedFile||"undefined"==typeof e.removeFileFromDisplay)throw"For custom display, two methods displayAddedFile and removeFileFromDisplay must be implemented";this.displayAddedFile=e.displayAddedFile,this.getSelectedFile=e.getSelectedFile,this.removeFileFromDisplay=e.removeFileFromDisplay}var t=this,i=e.preAdd,o=e.postAdd,s=e.onDuplicateAdd,r=e.validateFile,l=e.onCheckFail,a=e.preRemove,n=e.postRemove,d=e.preUpload,f=e.addPayload,p=e.postUpload,c=e.onSuccess,u=e.onError,v=e.preAddBtnAction,m=e.postAddBtnAction,h=e.preRemoveBtnAction,y=e.postRemoveBtnAction,g=e.preRemoveAllBtnAction,B=e.postRemoveAllBtnAction,F=e.preUploadBtnAction,A=e.postUploadBtnAction;this.chunkSize="undefined"!=typeof e.chunkSize?e.chunkSize:this.DEFAULT_CHUNK_SIZE;var U=function(e){v&&v();var n,d,a=function(e){i&&i(e),t.addFile(e),o&&o(e)};for(d=0;d<e.length;d+=1)n=e[d],t.filesToBeUploaded.contains(n)?s?s(n):alert("This file already exists"):r?r(n,a,l):a(n);t.resetAddBtn(),m&&m()};this.addBtn.addEventListener("change",function(e){var i=t.addBtn.files;U(i)}),this.fileTable&&(this.fileTable.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}),this.fileTable.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files;U(t)})),this.dropZone&&(this.dropZone.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}),this.dropZone.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files;U(t)})),this.removeBtn.addEventListener("click",function(){h&&h();var e;if(t.customDisplay){if(t.getSelectedFile)e=t.getSelectedFile();else{if(1!==t.filesToBeUploaded.length)throw"In custom display, getSelectedFile must be implemented when adding multiple files";e=t.filesToBeUploaded[0]}e&&(a&&a(e),t.remove(e),n&&n(e))}else{var o,s,i=document.getElementsByClassName("fileRowCheckBox");for(o=i.length-1;o>=0;o-=1)if(s=i[o],s.checked===!0){var r=s.parentElement.parentElement,l=r.rowIndex;e=t.filesToBeUploaded[l-1],a&&a(e),t.remove(e),n&&n(e)}}y&&y()}),this.removeAllBtn.addEventListener("click",function(){g&&g();var e,i;for(i=t.filesToBeUploaded.length;i>0;i-=1)e=t.filesToBeUploaded[i-1],t.remove(e);B&&B()}),this.uploadBtn.addEventListener("click",function(){F&&F();var e;if(t.customDisplay)if(t.getSelectedFile)e=t.getSelectedFile();else{if(1!==t.filesToBeUploaded.length)throw"In custom display, getSelectedFile must be implemented when adding multiple files";e=t.filesToBeUploaded[0]}else{var i=document.getElementsByClassName("fileRowCheckBox");if(1===i.length)e=t.filesToBeUploaded[0];else{var o,s;for(o=i.length-1;o>=0;o-=1)if(s=i[o],s.checked===!0){e=t.filesToBeUploaded[o];break}}}if(e){d&&d(e);var r;f&&(r=f(e)),t.uploadFile(e,c,u,r,p)}A&&A()})}File&&(File.prototype.equals=function(e){return this.name===e.name&&this.size===e.size&&this.type===e.type&&this.lastModified===e.lastModified}),Array.prototype.contains=function(e){if(this.indexOf(e)>-1)return!0;var t,i;for(i=0;i<this.length;i+=1)if(t=this[i],e.equals&&"function"==typeof e.equals){if(t.equals(e))return!0}else if(t===e)return!0;return!1},Array.prototype.removeByElement=function(e){var t=this.indexOf(e);t>-1&&this.splice(t,1)},Array.prototype.removeByIndex=function(e){this.splice(e,1)},Uploader.isSupported=function(){return File&&FileList&&FileReader&&Blob&&XMLHttpRequest},Uploader.prototype={constructor:Uploader,DEFAULT_CHUNK_SIZE:1048576,resetAddBtn:function(){this.wrapperForm.reset()},addFile:function(e){if(this.customDisplay)this.displayAddedFile(e);else{var t;this.getFileDetails?t=this.getFileDetails(e):(t.fileName=e.name,t.fileType=e.type,t.fileSize=e.size,t.fileLastModified=e.lastModified);var i=this.fileTable.insertRow(),o=this.selectedRowColor;i.insertCell().innerHTML="<input type='checkbox' class='fileRowCheckBox'>",i.style.cursor="pointer";var s=i.getElementsByClassName("fileRowCheckBox")[0];i.addEventListener("click",function(){s.checked?(s.checked=!1,i.style.backgroundColor="#ffffff"):(s.checked=!0,i.style.backgroundColor=o)}),s.addEventListener("click",function(){s.checked?(s.checked=!1,i.style.backgroundColor="#ffffff"):(s.checked=!0,i.style.backgroundColor=o)});var r;for(r in t)t.hasOwnProperty(r)&&(i.insertCell().innerHTML=t[r])}this.filesToBeUploaded.push(e)},remove:function(e){if(this.customDisplay)this.removeFileFromDisplay(e),this.filesToBeUploaded.removeByElement(e);else{var t=this.filesToBeUploaded.indexOf(e)+1;this.fileTable.deleteRow(t),this.filesToBeUploaded.removeByIndex(t-1)}},uploadFile:function(e,t,i,o,s){var u,r=this,l=new XMLHttpRequest,a=0,n=this.chunkSize,d=a+n,f=e.size,p=e.size%n===0?parseInt(e.size/n,10):parseInt(e.size/n,10)+1,c=function(){l.open("POST",r.serverUrl,!0);var t=new FormData;if(t.append("name",e.name),t.append("blob",e.slice(a,d)),t.append("totalChunks",p),a=d,d=a+n,f-=n,0>=f){t.append("eof",!0);var i;for(i in o)o.hasOwnProperty(i)&&t.append(i,o[i])}else t.append("eof",!1);l.send(t)},v=100/p,m=0;l.upload.onprogress=function(t){r.setProgress&&t.lengthComputable&&(u=m+t.loaded/t.total*v,r.setProgress(e,u))},l.upload.onloadend=function(e){r.getProgress&&(m=r.getProgress())},l.onreadystatechange=function(o){var l=o.target;l.readyState===XMLHttpRequest.DONE&&200===l.status?f>0?c(l):(r.setProgress&&r.setProgress(e,100),s&&s(e),r.removeAfterUploadSuccess&&r.remove(e),t(e,l.response,l)):l.readyState===XMLHttpRequest.DONE&&200!==l.status&&(r.removeAfterUploadFail&&r.remove(e),i(e,l.response,l.status,l))},c(l)}};
