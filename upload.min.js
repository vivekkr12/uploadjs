/*The MIT License (MIT) Copyright (c) 2016 Vivek Kumar https://github.com/vivekkr12/uploadjs/blob/master/LICENSE.md */
"use strict";function Uploader(e){if(this.filesToBeUploaded=[],this.fileTable=document.getElementById(e.fileTableId),this.dropZone=document.getElementById(e.dropZoneId),this.addBtn=document.getElementById(e.addBtnId),this.removeBtn=document.getElementById(e.removeBtnId),this.uploadBtn=document.getElementById(e.uploadBtnId),this.removeAllBtn=document.getElementById(e.removeAllBtnId),this.serverUrl=e.serverUrl,this.wrapperForm=document.getElementById(e.wrapperFormId),this.setProgress=e.setProgress,this.getProgress=e.getProgress,this.getFileDetails=e.getFileDetails,this.customDisplay="undefined"==typeof e.customDisplay?!1:e.customDisplay,this.customDisplay){if("undefined"==typeof e.displayAddedFile||"undefined"==typeof e.removeFileFromDisplay)throw"For custom display, two methods displayAddedFile and removeFileFromDisplay must be implemented";this.displayAddedFile=e.displayAddedFile,this.getSelectedFile=e.getSelectedFile,this.removeFileFromDisplay=e.removeFileFromDisplay}var a,n,l,t="undefined"==typeof e.asyncFileValidator?!1:e.asyncFileValidator,i=this,s=e.preAdd,o=e.postAdd,r=e.onDuplicateAdd;t?l=e.validateFile:(a=e.isValidFile,n=e.onCheckFail);var d=e.preRemove,f=e.postRemove,p=e.preUpload,u=e.addPayload,v=e.postUpload,c=e.onSuccess,h=e.onError,m=e.preAddBtnAction,y=e.postAddBtnAction,B=e.preRemoveBtnAction,g=e.postRemoveBtnAction,F=e.preRemoveAllBtnAction,T=e.postRemoveAllBtnAction,A=e.preUploadBtnAction,E=e.postUploadBtnAction;this.chunkSize="undefined"!=typeof e.chunkSize?e.chunkSize:this.DEFAULT_CHUNK_SIZE;var U=function(e){m&&m();var f,p,d=function(e){s&&s(e),i.addFile(e),o&&o(e)};for(p=0;p<e.length;p+=1)if(f=e[p],i.filesToBeUploaded.contains(f))r?r(f):alert("This file already exists");else if(t)l(f,d,n);else if(a){var u=a(f);if(u===!1){n&&n(f);continue}d(f)}i.resetAddBtn(),y&&y()};this.addBtn.addEventListener("change",function(e){var t=i.addBtn.files;U(t)}),this.fileTable&&(this.fileTable.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}),this.fileTable.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files;U(t)})),this.dropZone&&(this.dropZone.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}),this.dropZone.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files;U(t)})),this.removeBtn.addEventListener("click",function(){B&&B();var e;if(i.customDisplay){if(i.getSelectedFile)e=i.getSelectedFile();else{if(1!==i.filesToBeUploaded.length)throw"In custom display, getSelectedFile must be implemented when adding multiple files";e=i.filesToBeUploaded[0]}e&&(d&&d(e),i.remove(e),f&&f(e))}else{var s,o,t=document.getElementsByClassName("fileRowCheckBox");for(s=t.length-1;s>=0;s-=1)if(o=t[s],o.checked===!0){var r=o.parentElement.parentElement,a=r.rowIndex;e=i.filesToBeUploaded[a-1],d&&d(e),i.remove(e),f&&f(e)}}g&&g()}),this.removeAllBtn.addEventListener("click",function(){F&&F();var e,t;for(t=i.filesToBeUploaded.length;t>0;t-=1)e=i.filesToBeUploaded[t-1],i.remove(e);T&&T()}),this.uploadBtn.addEventListener("click",function(){A&&A();var e;if(i.customDisplay)e=i.getSelectedFile();else{var t=document.getElementsByClassName("fileRowCheckBox");if(1===t.length)e=i.filesToBeUploaded[0];else{var s,o;for(s=t.length-1;s>=0;s-=1)if(o=t[s],o.checked===!0){e=i.filesToBeUploaded[s];break}}}if(e){p&&p(e);var r;u&&(r=u(e)),i.uploadFile(e,c,h,r),v&&v(e)}E&&E()})}File&&(File.prototype.equals=function(e){return this.name===e.name&&this.size===e.size&&this.type===e.type&&this.lastModified===e.lastModified}),Array.prototype.contains=function(e){if(this.indexOf(e)>-1)return!0;var t,i;for(i=0;i<this.length;i+=1)if(t=this[i],e.equals&&"function"==typeof e.equals){if(t.equals(e))return!0}else if(t===e)return!0;return!1},Array.prototype.removeByElement=function(e){var t=this.indexOf(e);t>-1&&this.splice(t,1)},Array.prototype.removeByIndex=function(e){this.splice(e,1)},Uploader.isSupported=function(){return File&&FileList&&FileReader&&Blob&&XMLHttpRequest},Uploader.prototype={constructor:Uploader,DEFAULT_CHUNK_SIZE:1048576,resetAddBtn:function(){this.wrapperForm.reset()},addFile:function(e){if(this.customDisplay)this.displayAddedFile(e);else{var t;this.getFileDetails?t=this.getFileDetails(e):(t.fileName=e.name,t.fileType=e.type,t.fileSize=e.size,t.fileLastModified=e.lastModified);var i=this.fileTable.insertRow();i.className="fileTableRow",i.insertCell().innerHTML="<input type='checkbox' class='fileRowCheckBox'>";var s;for(s in t)t.hasOwnProperty(s)&&(i.insertCell().innerHTML=t[s])}this.filesToBeUploaded.push(e)},remove:function(e){if(this.customDisplay)this.removeFileFromDisplay(e),this.filesToBeUploaded.removeByElement(e);else{var t=this.filesToBeUploaded.indexOf(e)+1;this.fileTable.deleteRow(t),this.filesToBeUploaded.removeByIndex(t-1)}},uploadFile:function(e,t,i,s){var u,o=this,r=new XMLHttpRequest,a=0,n=this.chunkSize,l=a+n,d=e.size,f=e.size%n===0?parseInt(e.size/n,10):parseInt(e.size/n,10)+1,p=function(){r.open("POST",o.serverUrl,!0);var t=new FormData;if(t.append("name",e.name),t.append("blob",e.slice(a,l)),t.append("totalChunks",f),a=l,l=a+n,d-=n,0>=d){t.append("eof",!0);var i;for(i in s)s.hasOwnProperty(i)&&t.append(i,s[i])}else t.append("eof",!1);r.send(t)},v=100/f,c=0;r.upload.onprogress=function(e){o.setProgress&&e.lengthComputable&&(u=c+e.loaded/e.total*v,o.setProgress(u))},r.upload.onloadend=function(e){c=o.getProgress()},r.onreadystatechange=function(s){var r=s.target;r.readyState===XMLHttpRequest.DONE&&200===r.status?d>0?p(r):(o.setProgress&&o.setProgress(100),t(e,r.response)):r.readyState===XMLHttpRequest.DONE&&200!==r.status&&i(e,r.response,r.statusText)},p(r)}};